{% import 'razorpay_frappe/razorpay_integration/email_macros.html' as razorpay_macros %}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ doc.doctype }} - {{ doc.name }}</title>
    <style>
      /* --- Begin: Copied CSS from print_format_template_new.html (Google Fonts import removed for PDF reliability) --- */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      .email-container {
        max-width: 800px;
        margin: 0 auto;
        background: #ffffff;
        border-radius: 16px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }
      .header {
        background: #ffffff;
        color: #1e293b;
        padding: 0;
        position: relative;
        border-bottom: 1px solid #e2e8f0;
      }
      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 30px 20px;
        max-width: 1200px;
        margin: 0 auto;
      }
      .header-left {
        display: flex;
        align-items: center;
        gap: 40px;
      }
      .company-logo {
        flex-shrink: 0;
      }
      .company-logo img {
        height: 60px;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
      }
      .company-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .company-name {
        font-size: 16px;
        font-weight: 700;
        color: #1e293b;
        line-height: 1.2;
      }
      .company-tagline {
        font-size: 14px;
        color: #64748b;
        font-weight: 400;
        margin-bottom: 8px;
      }
      .company-details {
        font-size: 12px;
        color: #64748b;
        line-height: 1.4;
      }
      .company-details strong {
        color: #1e293b;
        font-weight: 600;
      }
      .header-right {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 4px;
      }
      .document-badge {
        background: #1e293b;
        color: #ffffff;
        border-radius: 6px;
        padding: 8px 16px;
        font-size: 12px;
        font-weight: 600;
        letter-spacing: 1px;
        text-transform: uppercase;
        display: inline-block;
      }
      .document-info {
        font-size: 14px;
        color: #171c23;
        text-align: right;
      }
      .content {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
      }
      .quote-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
      }
      .meta-item {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 15px;
        background: #ffffff;
        border-radius: 6px;
        border: 1px solid #e2e8f0;
        transition: all 0.3s ease;
      }
      .meta-item:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
      }
      .meta-icon {
        width: 35px;
        height: 35px;
        background: #033b980d;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 16px;
        flex-shrink: 0;
      }
      .meta-text {
        flex: 1;
        min-width: 0;
      }
      .meta-label {
        font-size: 10px;
        color: #64748b;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
      }
      .meta-value {
        font-size: 13px;
        font-weight: 500;
        color: #1e293b;
        line-height: 1.3;
      }
      .meta-value strong {
        font-weight: 600;
        color: #1e293b;
      }
      .meta-value br {
        margin-bottom: 1px;
      }
      .address-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 25px;
        margin-bottom: 30px;
      }
      .address-card {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 25px;
        position: relative;
        overflow: hidden;
      }
      .address-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: #1e293b;
      }
      .address-title {
        font-size: 14px;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 15px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .address-content {
        font-size: 14px;
        line-height: 1.6;
        color: #475569;
      }
      .section-title {
        font-size: 18px;
        font-weight: 600;
        color: #1e293b;
        margin: 35px 0 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e2e8f0;
        position: relative;
      }
      .section-title::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 60px;
        height: 2px;
        background: #1e293b;
      }
      .table-container {
        background: #ffffff;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        border: 1px solid #e2e8f0;
        margin-bottom: 25px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      th {
        background: #0062ff2e;
        color: #000000;
        font-weight: 600;
        padding: 15px 12px;
        text-align: left;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: none;
        border-bottom: 2px solid #e2e8f0;
      }
      td {
        padding: 4px;
        border-bottom: 1px solid #e5e5e5;
        vertical-align: top;
        color: #475569;
      }
      tbody tr:nth-child(even) {
        background-color: #f8fafc;
      }
      tbody tr:hover {
        background-color: #f1f5f9;
      }
      .text-right {
        text-align: right;
      }
      .amount {
        font-weight: 600;
        color: #1e293b;
      }
      .totals-table {
        background: #f8fafc;
        border-radius: 12px;
        overflow: hidden;
        margin-top: 20px;
      }
      .totals-table td {
        padding: 12px 20px;
        border: none;
        font-size: 14px;
      }
      .totals-table .grand {
        background: #0062ff2e;
        color: #000000;
        font-size: 18px;
        font-weight: 700;
      }
      .amount-words {
        background: #fef3c7;
        border: 1px solid #f59e0b;
        border-radius: 8px;
        padding: 20px 25px;
        margin-top: 20px;
        font-style: italic;
        color: #92400e;
        font-size: 16px;
        line-height: 1.5;
      }
      .amount-words strong {
        color: #92400e;
        font-weight: 600;
        font-size: 18px;
      }
      .payment-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 25px;
        margin-top: 30px;
      }
      .payment-card {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 14px;
        position: relative;
        overflow: hidden;
      }
      .payment-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
      }
      .razorpay-card::before {
        background: #10b981;
      }
      .bank-card::before {
        background: #f59e0b;
      }
      .payment-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .razorpay-title {
        color: #065f46;
      }
      .bank-title {
        color: #92400e;
      }
      .qr-section {
        display: flex;
        align-items: center;
        gap: 20px;
        flex-wrap: wrap;
      }
      .qr-code {
        text-align: center;
      }
      .qr-code img {
        width: 150px;
        height: 150px;
        border-radius: 12px;
        padding: 8px;
        background: #ffffff;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
      }
      .payment-details {
        flex: 1;
        font-size: 13px;
        line-height: 1.6;
      }
      .scan-text {
        font-size: 16px;
        font-weight: 600;
        color: #065f46;
        margin-bottom: 8px;
      }
      .payment-link {
        color: #065f46;
        text-decoration: none;
        word-break: break-word;
      }
      .payment-link:hover {
        text-decoration: underline;
      }
      .bank-details {
        line-height: 1.8;
        font-size: 13px;
        color: #475569;
      }
      .bank-details strong {
        color: #92400e;
        font-weight: 600;
      }
      .terms-section {
        margin-top: 40px;
        padding: 25px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
      }
      .terms-list {
        list-style: none;
        padding: 0;
        margin: 0;
        font-size: 12px;
        line-height: 1.5;
        color: #475569;
      }
      .terms-list li {
        margin-bottom: 8px;
        padding-left: 0;
        position: relative;
      }
      .terms-list li:before {
        content: "‚Ä¢";
        color: #1e293b;
        font-weight: bold;
        position: absolute;
        left: -15px;
      }
      .terms-list li:last-child {
        margin-bottom: 0;
      }
      .terms-list strong {
        color: #1e293b;
        font-weight: 600;
      }
      .footer {
        background: #ffffffc0;
        color: #000000;
        text-align: center;
        padding: 30px;
        font-size: 12px;
        line-height: 1.6;
      }
      .footer-content {
        opacity: 0.8;
      }
      @media (max-width: 768px) {
        body {
          padding: 10px;
        }
        .header-content {
          flex-direction: column;
          gap: 20px;
          text-align: center;
          padding: 20px;
        }
        .header-left {
          flex-direction: column;
          gap: 15px;
        }
        .header-right {
          align-items: center;
        }
        .quote-meta {
          grid-template-columns: 1fr;
          gap: 12px;
          padding: 15px;
        }
        .meta-item {
          padding: 12px;
        }
        .content {
          padding: 20px;
        }
        .address-section {
          grid-template-columns: 1fr;
          gap: 20px;
        }
        .payment-section {
          grid-template-columns: 1fr;
          gap: 20px;
        }
        .qr-section {
          flex-direction: column;
          text-align: center;
        }
      }
      @media print {
        body {
          background: #ffffff;
          padding: 0;
        }
        .email-container {
          box-shadow: none;
          border-radius: 0;
        }
        .header {
          background: #667eea4f;
        }
        tbody tr:hover {
          background-color: transparent;
        }
      }
      .print-format {
        font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: #000000;
        line-height: 1.6;
        background: #ffffff;
        padding: 10px;
    }
      /* --- End: Copied CSS --- */
    </style>
  </head>
  <body>
    <div class="email-container">
      <!-- Header -->
      <div class="header">
        <div class="header-content">
          <div class="header-left">
            <div class="company-logo">
              <img src="/files/with%20black%20png%20logo.png" alt="{{ doc.company }}" />
            </div>
            <div class="company-info">
              <div class="company-name">{{ doc.company }}</div>
              <div class="company-details">
                {% for line in doc.company_address_display.split('\n') %}
                  {% if line.strip() %}
                    {{ line.strip() }}
                  {% endif %}
                {% endfor %}
                {% if doc.company_gstin %}GSTIN: {{ doc.company_gstin }}<br />{% endif %}
                {% if doc.company_email %}Email: {{ doc.company_email }}{% endif %}
              </div>
              
            </div>
          </div>
          <div class="header-right">
            <div class="document-badge">{{ doc.doctype }}</div>
            <strong>No:</strong> <div class="document-info">{{ doc.name }} / {{ frappe.utils.format_date(doc.posting_date or doc.transaction_date) }}</div>
            {% if doc.valid_till %}<strong>Validity:</strong> {{ frappe.utils.format_date(doc.valid_till) }}<br />{% endif %}
          </div>
        </div>
      </div>
      <!-- Content -->
      <div class="content">
        <!-- Quote Meta -->
        <div class="quote-meta">
          <div class="meta-item">
            <div class="meta-icon">üìç</div>
            <div class="meta-text">
              <div class="meta-label">Bill To</div>
              <div class="meta-value">
                <strong>{{ doc.customer_name or doc.party_name }}</strong><br />
                {% for line in doc.address_display.split('\n') %}
                  {% if line.strip() %}
                    {{ line.strip() }}
                  {% endif %}
                {% endfor %}
                {% if doc.customer_gstin %}GSTIN: {{ doc.customer_gstin }}{% endif %}
              </div>
            </div>
          </div>
          <div class="meta-item">
            <div class="meta-icon">üöö</div>
            <div class="meta-text">
              <div class="meta-label">Ship To</div>
              <div class="meta-value">
                {% if doc.shipping_address %}
                  {% for line in doc.shipping_address.split('\n') %}
                    {% if line.strip() %}
                      {{ line.strip() }}
                    {% endif %}
                  {% endfor %}
                {% else %}
                  Same as billing address
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        <!-- Item Details -->
        <div class="section-title">Item Details</div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Item Code</th>
                <th>Description</th>
                <th>HSN</th>
                <th>Qty</th>
                <th>UOM</th>
                <th>Rate</th>
                <th>Discount</th>
                <th>Taxable</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody>
              {% for row in doc.items %}
              <tr>
                <td>{{ row.idx }}</td>
                <td>{{ row.item_code }}</td>
                <td>{{ row.item_name }}{% if row.description %}<br /><span style="color:#64748b;">{{ row.description }}</span>{% endif %}</td>
                <td>{{ row.gst_hsn_code }}</td>
                <td class="text-right">{{ row.qty }}</td>
                <td>{{ row.uom }}</td>
                <td class="text-right amount">{{ row.get_formatted('rate') }}</td>
                <td class="text-right amount">{{ frappe.utils.fmt_money(row.discount_amount, currency=doc.currency) }}</td>
                <td class="text-right amount">{{ row.get_formatted('taxable_value') }}</td>
                <td class="text-right amount">{{ row.get_formatted('amount') }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <!-- GST Summary -->
        {% set gst_breakup_data = json.loads(get_gst_breakup(doc)) %}
        {% if gst_breakup_data %}
        {% set is_doc_return = doc.get('is_return') %}
        <div class="section-title">GST Breakup Summary</div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                {% for key in gst_breakup_data[0].keys() %}
                  {% if key in ["HSN/SAC", "Item"] %}
                    <th class="text-left">{{ key }}</th>
                  {% else %}
                    <th class="text-right">{{ key }}</th>
                  {% endif %}
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for row in gst_breakup_data %}
                <tr>
                  {% for key, value in row.items() %}
                    {% if key in ["HSN/SAC", "Item"] %}
                      <td class="text-left">{{ value }}</td>
                    {% elif key == "Taxable Amount" %}
                      <td class="text-right amount">
                        {% if is_doc_return %}
                          {{ frappe.utils.fmt_money(value | abs, None, doc.currency) }}
                        {% else %}
                          {{ frappe.utils.fmt_money(value, None, doc.currency) }}
                        {% endif %}
                      </td>
                    {% else %}
                      <td class="text-right">
                        {% if value.tax_rate or not value.tax_amount %}({{ value.tax_rate }}%)&nbsp;{% endif %}
                        {% if is_doc_return %}
                          {{ frappe.utils.fmt_money(value.tax_amount | abs, None, doc.currency) }}
                        {% else %}
                          {{ frappe.utils.fmt_money(value.tax_amount, None, doc.currency) }}
                        {% endif %}
                      </td>
                    {% endif %}
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}
        <!-- Totals -->
        <div class="table-container totals-table">
          <table>
            <tr>
              <td>Subtotal (Taxable)</td>
              <td class="text-right amount">{{ doc.get_formatted('net_total') or doc.get_formatted('total') }}</td>
            </tr>
            <tr>
              <td>CGST</td>
              <td class="text-right amount">{{ frappe.utils.fmt_money(doc.total_cgst or 0, currency=doc.currency) }}</td>
            </tr>
            <tr>
              <td>SGST</td>
              <td class="text-right amount">{{ frappe.utils.fmt_money(doc.total_sgst or 0, currency=doc.currency) }}</td>
            </tr>
            {% if doc.discount_amount %}
            <tr>
              <td>Discount</td>
              <td class="text-right amount">{{ doc.get_formatted('discount_amount') }}</td>
            </tr>
            {% endif %}
            <tr class="grand">
              <td>Grand Total</td>
              <td class="text-right">{{ doc.get_formatted('grand_total') }}</td>
            </tr>
          </table>
        </div>
        <div class="amount-words">
          <strong>Amount in Words:</strong> {{ doc.in_words }}
        </div>
        <!-- Payment Section -->
        <div class="payment-section">
          <!-- Razorpay -->
          <div class="payment-card razorpay-card">
            <div class="payment-title razorpay-title">
              üí≥ Make Payment via Razorpay
            </div>
            <div class="qr-section">
              <div class="qr-code">
                {% if doc.razorpay_link %}
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=100x100&data={{ doc.razorpay_link }}" alt="QR Code" />
                {% endif %}
              </div>
              <div class="payment-details">
                <div class="scan-text">Scan to Pay</div>
                <strong>Payment Link:</strong><br />
                {% if doc.razorpay_link %}
                <a href="{{ doc.razorpay_link }}" target="_blank" class="payment-link">{{ doc.razorpay_link }}</a>
                {% else %}
                <span style="color:#aaa;">Payment link not generated</span>
                {% endif %}
              </div>
            </div>
          </div>
          <!-- Bank Transfer -->
          <div class="payment-card bank-card">
            <div class="payment-title bank-title">
              üè¶ Bank Transfer Details
            </div>
            <div class="bank-details">
              {% set company = frappe.get_doc("Company", doc.company) %}
              {% set bank_ac_name = None %}
              {% if company.default_bank_account %}
                {# If default_bank_account points directly to a Bank Account doc #}
                {% if frappe.db.exists("Bank Account", company.default_bank_account) %}
                  {% set bank_ac_name = company.default_bank_account %}
                {% else %}
                  {# Otherwise, try to locate Bank Account whose `account` = that GL account #}
                  {% set bank_ac_name = frappe.db.get_value("Bank Account", {"account": company.default_bank_account, "disabled":0}, "name") %}
                {% endif %}
              {% endif %}
              {% if bank_ac_name %}
                {% set bank_ac = frappe.get_doc("Bank Account", bank_ac_name) %}
                <strong>Account Name:</strong> {{ bank_ac.account_name }}<br />
                <strong>Bank:</strong> {{ bank_ac.bank }}<br />
                {% if bank_ac.bank_account_no %}<strong>A/C No:</strong> {{ bank_ac.bank_account_no }}<br />{% endif %}
                {% if bank_ac.branch_code %}<strong>Branch Code:</strong> {{ bank_ac.branch_code }}<br />{% endif %}
                {% if bank_ac.custom_ifsc_code %}<strong>IFSC Code:</strong> {{ bank_ac.custom_ifsc_code }}<br />{% endif %}
                {% if bank_ac.iban %}<strong>IBAN:</strong> {{ bank_ac.iban }}<br />{% endif %}
                {% if bank_ac.upi_id %}<strong>UPI ID:</strong> {{ bank_ac.upi_id }}<br />{% endif %}
              {% else %}
                <em>No bank details found for {{ company.name }}.</em>
              {% endif %}
            </div>
          </div>
        </div>
        <!-- Terms and Conditions -->
        <div class="terms-section">
          <div class="section-title">Terms and Conditions</div>
          <ul class="terms-list">
            <li><strong>Pricing:</strong> All prices are ex-works, GST extra as applicable. Prices are subject to change without prior notice.</li>
            <li><strong>Payment Terms:</strong> 100% advance payment required before order processing. Payment accepted via bank transfer, UPI, or Razorpay payment link.</li>
            <li><strong>Delivery:</strong> Delivery timeline is 4 weeks from receipt of Purchase Order and 100% advance payment. Delivery dates are estimates and may vary based on order complexity.</li>
            <li><strong>Warranty:</strong> 1 year warranty against manufacturing defects from the date of delivery. Warranty covers replacement of defective parts only.</li>
            <li><strong>Returns Policy:</strong> Goods once sold will not be taken back or exchanged unless found defective during warranty period.</li>
            <li><strong>Force Majeure:</strong> Company shall not be liable for any delay or failure in performance due to circumstances beyond reasonable control.</li>
            <li><strong>Quality Standards:</strong> All products are manufactured as per industry standards and company quality specifications.</li>
            <li><strong>Installation:</strong> Installation services are not included unless specifically mentioned in the order.</li>
            <li><strong>GST Compliance:</strong> All applicable taxes including GST will be charged as per current rates. HSN/SAC codes are mentioned for tax compliance.</li>
            <li><strong>Dispute Resolution:</strong> Any disputes shall be subject to the jurisdiction of local courts only.</li>
          </ul>
        </div>
      </div>
      <!-- Footer -->
      <div class="footer">
        <div class="footer-content">
          This is a computer-generated document. No signature required.<br />
          Thank you for your business!
        </div>
      </div>
    </div>
  </body>
</html> 